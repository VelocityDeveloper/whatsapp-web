<!DOCTYPE html>
<html>
<head>
	<title>Whatsapp API</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- This parts is optional, just for improve the styles -->

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/smooth-scrollbar/5.0.1/smooth-scrollbar.css" integrity="sha512-QyDQGQiuKrcAtAIPIaO+IBZNkmb/+U5dyMY2Qe64mhjKiF74QWuDhjrqgkbacfQqqFB2+fwWnan5TQHlb0mfUg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="/css/style.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/img/whatsapp.png">
</head>
<body>

	<div id="app">
        <div class="frame-chat">
            <div class="row m-0">
                <div class="col-4 col-md-3 p-0 position-relative">
                    <img src="" alt="QR Code" id="qrcode">
                    <div class="search-form">
                        <input class="form-control rounded-0" placeholder="Search Contact..">
                    </div>
                    
                    <div class="sidebar-chat sidebar-chat area-kontak">
                        <ul class="list-group chat pb-5"></ul>
                    </div>
                </div>
                <div class="col position-relative p-0 height-100vh">
                    <div class="chat-header d-flex flex-row align-items-center">
                        <div class="p-2" >
                            <img style="width:40px;" class="rounded-circle img-fluid pic-current" data-user="" src="" alt="">
                        </div>
                        <div class="p-2">
                            <span class="current-name">
                            </span>
                        </div>
                    </div>
                    <div class="area-pesan chat-cols">
                        <div class="chatarea">
                        </div>
                    </div>
                    <div class="fixed-chatform bg-dark">

                        <form class="kirim-chat">
                            <div class="row mx-0">
                                <div class="col-10">
                                    <label for="lampiran" class="blue-100 lampiran">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-paperclip" viewBox="0 0 16 16">
                                            <path d="M4.5 3a2.5 2.5 0 0 1 5 0v9a1.5 1.5 0 0 1-3 0V5a.5.5 0 0 1 1 0v7a.5.5 0 0 0 1 0V3a1.5 1.5 0 1 0-3 0v9a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 1 1 0v7a3.5 3.5 0 1 1-7 0V3z"/>
                                        </svg>
                                    </label>
                                    <input id="lapiran" type="file" class=" form-control d-none" >
                                    <textarea class="body-message form-control" placeholder="" rows="1"></textarea>
                                </div>
                                <div class="col-2">
                                    <button class="btn btn-success w-100">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                                            <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                                        </svg>
                                    </button>
                                </div>

                            </div>
                        </form>

                        
                    </div>
                    <ul class="list-group logs d-none">
                    </ul>
                </div>
            </div>
        </div>
		
		
	</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/smooth-scrollbar/5.0.1/smooth-scrollbar.js" integrity="sha512-fNprFnoeUomE0+m0nYtgoIrlUm81yW4dtuBVhMluVYlbpYEGMfEbUJJN4muTYiltfmDyWkQ5TpmwmIhdFK7qEA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js" integrity="sha512-CryKbMe7sjSCDPl18jtJI5DR5jtkUWxPXWaLCst6QjH8wxDexfRJic2WRmRXmstr2Y8SxDDWuBO6CQC6IE4KTA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment-with-locales.min.js" integrity="sha512-42PE0rd+wZ2hNXftlM78BSehIGzezNeQuzihiBCvUEB3CVxHvsShF86wBWwQORNxNINlBPuq7rG4WWhNiTVHFg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/id.min.js" integrity="sha512-he8U4ic6kf3kustvJfiERUpojM8barHoz0WYpAUDWQVn61efpm3aVAD8RWL8OloaDDzMZ1gZiubF9OSdYBqHfQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js" crossorigin="anonymous"></script>
	<script>

        let Scrollbar = window.Scrollbar;
        var options = {
            alwaysShowTracks : true
        };

        Scrollbar.init(document.querySelector('.area-kontak'));
        // Scrollbar.init(document.querySelector('.area-pesan'),options);
        // const chatScrollbar = Scrollbar.init(document.querySelector('.area-pesan'), {
        // damping: 0.2,
        // alwaysShowTracks : true
        // });
        // Scrollbar.init(document.querySelector('.fixed-chatform'))

		(function($) {
            $(document).ready(function() {
                const socket = io();
                const localData = JSON.parse(localStorage.getItem('curentchat'));
                const localNomor = localData?.nomor;
                const localId = localData?.id;
                const localNama = localData?.nama;

                // init kontak
                socket.emit('updateDataContact', 'request Data Kontak');
                socket.on('chatMasuk', function(msg) {
                    socket.emit('updateDataContact', 'request Data Kontak karena chat masuk');
                });

                if(localNomor && localId){
                    socket.emit('getchatbyid', localNomor);
                    socket.emit('reqPicUrl', localId);
                    $('.pic-current').attr('data-user', localId);
                    $('.current-name').html(localNama);
                }
                $(".body-message").keypress(function (e) {
                    if(e.which == 13) {
                        $('.kirim-chat').submit();
                        e.preventDefault();
                    }
                });
                $(document).on("click",".list-contact",function() {
                    $('.list-contact').removeClass('active');
                    $(".kirim-chat .body-message").val('');
                    $( this ).addClass('active');
                    let nomor = $( this ).data('nomor');
                    let id = $( this ).data('id');
                    let nama = $( this ).data('nama');
                    let dataUser = {
                        'id': id,
                        'nomor': nomor,
                        'nama' : nama
                    };
                    localStorage.setItem('curentchat', JSON.stringify(dataUser));

                    // getchatbyid
                    socket.emit('getchatbyid', nomor);

                    $('.pic-current').attr('data-user', id);
                    $('.current-name').html(nama);
                    $('.chatarea').html('');
                    socket.emit('reqPicUrl', id);
                    
                });

                $(document).on("keyup",".search-form input",function() {
                    var value = $(this).val();
                    $('.list-contact').removeClass('d-none');
                    var filter = $(this).val().toLowerCase(); // get the value of the input, which we filter on
                    if(value.length > 1){
                        $('.list-contact').each(function(i, obj) {
                            $(this).addClass('d-none');
                            if($(this).attr('class').toString().indexOf(filter) > 1) {
                                $(this).removeClass('d-none');
                            }
                        });
                    }
                });

                $( ".kirim-chat" ).submit(function( event ) {       
                    const localData = JSON.parse(localStorage.getItem('curentchat'));
                    const localNomor = localData?.nomor;
                    const localId = localData?.id;
                    const localNama = localData?.nama;
                    let message = $(this).find(".body-message").val();
                    socket.emit('sentMessage', {'nomor':localNomor,'message':message});
                    $(".kirim-chat .body-message").val('');
                    event.preventDefault();
                });

                socket.on('message', function(msg) {
                    $('.logs').prepend($('<li class="list-group-item">').text(msg));
                });

                socket.on('getPicUrl', function(msg) {
                    if(msg.url){
                        $(`[data-user='`+msg.data+`']`).attr("src", msg.url);
                    } else {
                        $(`[data-user='`+msg.data+`']`).attr("src", '/img/whatsapp.png');
                    }
                });

                socket.on('getMedia', function(msg) {
                    const downloadicon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-arrow-down-fill" viewBox="0 0 16 16">
                                            <path d="M8 2a5.53 5.53 0 0 0-3.594 1.342c-.766.66-1.321 1.52-1.464 2.383C1.266 6.095 0 7.555 0 9.318 0 11.366 1.708 13 3.781 13h8.906C14.502 13 16 11.57 16 9.773c0-1.636-1.242-2.969-2.834-3.194C12.923 3.999 10.69 2 8 2zm2.354 6.854-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 1 1 .708-.708L7.5 9.293V5.5a.5.5 0 0 1 1 0v3.793l1.146-1.147a.5.5 0 0 1 .708.708z"/>
                                            </svg>`;
                    const img =['jpg','jpeg','png','gif','webp'];
                    const audio =['ogg','mp3','oga'];
                    const video = ['mp4'];
                    console.log(msg);
                    if(img.includes(msg.ext)){
                        $('[data-media="'+msg.key+'"]').html('<img src="/download/'+msg.name+'" alt="">');
                    } else if(video.includes(msg.ext)) {
                        $('[data-media="'+msg.key+'"]').html(`
                        <video width="320" controls>
                        <source src="/download/`+msg.name+`" type="video/mp4">
                        Your browser does not support the video tag.
                        </video>`);
                    } else if(audio.includes(msg.ext)) {
                        $('[data-media="'+msg.key+'"]').html(`
                        <audio controls>
                        <source src="/download/`+msg.name+`" type="video/mp4">
                        Your browser does not support the video tag.
                        </audio>`);
                    } else {
                        $('[data-media="'+msg.key+'"]').html('<a class="btn btn-dark" href="/download/'+msg.name+'" download>'+downloadicon+' '+msg.name+'</a>');
                    }
                });

                socket.on('getContact', function(data) {
                    if(data){
                        $('.chat').html('');
                        const dataListChat = data.sort();
                        // dataListChat.sort((a, b));

                        var arrayLength = dataListChat.length;
                        for (var i = 0; i < arrayLength; i++) {
                            let dataContact = dataListChat[i]?.data;
                            socket.emit('reqPicUrl', dataContact.id);
                            //Do something
                            let contact = ``
                                contact +=`<div class="row card-contact">`;
                                    contact +=`<div class="col-2 px-0">
                                            <img class="rounded-circle img-fluid" data-user="`+dataContact.id+`" src="" alt="">
                                            </div>
                                            <div class="col-10">
                                            <div class="ms-2 me-auto">
                                            <div class="data-nama">`+dataContact.name+`</div>
                                            <div style="font-size:8px;">`+moment.unix(dataContact.timestamp).format("DD-MM-YYYY h:mm:ss")+`</div>
                                        </div>`;
                                        if(dataContact.unreadCount < 0){
                                            contact +=`<span class="badge bg-success rounded-pill text-success">!</span>`;
                                        } else if (dataContact.unreadCount >= 1) {
                                            contact +=`<span class="badge bg-success rounded-pill">`+dataContact.unreadCount+`</span>`;
                                        }
                                    contact +=`</div>`;
                                contact +=`</div>`;
                                
                            $('.chat').append($('<li class="text-white bg-dark list-contact list-'+dataContact.nomor+' '+dataContact.name.toLowerCase()+' list-group-item align-start" data-id="'+dataContact.id+'" data-nomor="'+dataContact.nomor+'" data-nama="'+dataContact.name+'"></li>')
                            .html(contact));
                        }
                        if(localNomor){
                            $('.list-'+localNomor).addClass( "active" );
                        }
                    }
                });

                socket.on('sentMessageSuccess', function(data) {
                    $(".body-message").val('');
                });

                socket.on('getChatByNumber', function(data) {
                    const localData = JSON.parse(localStorage.getItem('curentchat'));
                    const localNomor = localData?.nomor;
                    const localId = localData?.id;
                    const localNama = localData?.nama;
                    let html = '';
                    if( [data.from , data.to].includes(localId) ){
                        const value = data;
                        let divClass = value.fromMe == true ? 'chat-to' : 'chat-from';
                        html += '<div class="'+divClass+'"><span>';

                        if (value.hasMedia) {
                            html += `<div data-media="`+value.mediaKey+`"></div>`;
                        } else {
                            html += value.body;
                        }

                        html += '<div><small style="font-size:8px;">'+ moment.unix(value.timestamp).format("DD-MM-YYYY h:mm:ss") + "</small></div>";
                        html += '</span></div>';
                        $(".chatarea").append(html);
                    }

                    // setTimeout(function() {
                    //     let tinggiChat = $('.chatarea').height();
                    //     chatScrollbar.scrollTo(0, tinggiChat, 0, {
                    //     });
                    // }, 1000);
                });

                socket.on('qr', function(src) {
                    $('#qrcode').attr('src', src);
                    $('#qrcode').show();
                });

                socket.on('ready', function(data) {
                    $('#qrcode').hide();
                });

                socket.on('authenticated', function(data) {
                    $('#qrcode').hide();
                });
                socket.on('log', function(data) {
                    console.log(data);
                });
            });
        })(jQuery);
	</script>
</body>
</html>